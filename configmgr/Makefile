# GCC automatically takes CPATH and C_INCLUDE_PATH environment variables
# so only need to handle any additional paths that user wants to pass to make
# in EXTRA_C_INCLUDE_PATHS (whitespace-separated)
INCLUDEDIRS=$(foreach p,$(EXTRA_C_INCLUDE_PATHS),-I$p)

# CC, LD and RM are assumed to be predefined or the default overridden by user

CFLAGS+=-fPIC -Wall -Wextra -Wunused -O2
LDFLAGS+=-shared

LOCAL_INCLUDE_PATH = ../include
LOCAL_LIBS=tinyalsa expat

TRG=libaudiohalcm.so
SRC=audio_config.c
LIB=$(foreach p,$(LOCAL_LIBS),-l$p)
OBJ=${SRC:.c=.o}
DEP=${SRC:.c=.d}

.PHONY: all build clean
all: build

%.d: %.c
	${CC} ${INCLUDEDIRS} -I${LOCAL_INCLUDE_PATH} ${CFLAGS} -M -o $@ $<

# Pull in all .c file dependencies generated by rule above
-include ${DEP}

build: ${TRG}

${TRG}: ${OBJ}
	${LD} ${LDFLAGS} ${LIB} $^ -o $@

%.o: %.c
	${CC} ${INCLUDEDIRS} -I${LOCAL_INCLUDE_PATH} ${CFLAGS} -c -o $@ $<

clean:
	-${RM} ${TRG} ${OBJ} ${DEP}
